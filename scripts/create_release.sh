#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/create_release.sh 4.1.0

set -e

VERSION=$1

if [ -z "$VERSION" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä—Å–∏—è"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <version>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 4.1.0"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏ (X.Y.Z)
if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç X.Y.Z (–Ω–∞–ø—Ä–∏–º–µ—Ä: 4.1.0)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
if [ ! -f "CHANGELOG.md" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª CHANGELOG.md –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ç–µ–≥ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git rev-parse "v$VERSION" >/dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ç–µ–≥ v$VERSION —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
fi

echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ v$VERSION..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ CHANGELOG.md –æ–±–Ω–æ–≤–ª–µ–Ω
if grep -q "## \[Unreleased\]" CHANGELOG.md; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–∞–∑–¥–µ–ª —Å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–µ–π
    if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –≤ CHANGELOG.md –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ [Unreleased]"
        echo "   –î–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –≤—Å–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –≤ –≤–µ—Ä—Å–∏–∏ $VERSION"
        echo "   –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Ä–µ–ª–∏–∑–æ–≤ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª [$VERSION]"
        read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–µ—Ç –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if ! git diff-index --quiet HEAD --; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–ª–∏–∑–∞"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞
echo "üìå –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ v$VERSION..."
git tag -a "v$VERSION" -m "Release version $VERSION"

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–≥–∞
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–≥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git push origin "v$VERSION"

echo ""
echo "‚úÖ –†–µ–ª–∏–∑ v$VERSION —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ GitHub: https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/releases/new"
echo "   2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥ v$VERSION"
echo "   3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ CHANGELOG.md –¥–ª—è –≤–µ—Ä—Å–∏–∏ $VERSION"
echo "   4. –ù–∞–∂–º–∏—Ç–µ 'Publish release'"
echo ""
echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)"

