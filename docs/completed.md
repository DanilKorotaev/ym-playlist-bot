# Выполненные задачи ✅

История выполненных задач проекта. Задачи организованы по категориям для удобной навигации.

## Формат записей

В этом файле каждая выполненная задача представлена только **заголовком и ссылкой** на файл задачи. Все детали реализации, описание, план и чеклист остаются в файле задачи в папке `tasks/`.

**Формат:**
- `- [x] [Название задачи](tasks/task-name.md) ✅`

Это позволяет:
- Избежать дублирования информации
- Хранить все детали в одном месте (в файле задачи)
- Легко находить полную информацию о задаче по ссылке

## Основной функционал

- [x] Реализовать авторизацию через токен (`/set_token`)
- [x] Создать абстракции для работы с API Яндекс.Музыки (`YandexClientManager`)
- [x] Множественные плейлисты (каждый пользователь может создать свой)
- [x] Шаринг плейлистов через ссылки
- [x] Управление доступом (создатель/участник)
- [x] Разделение на "мои плейлисты" и "общие плейлисты"
- [x] Inline-кнопки для выбора плейлиста

## База данных и инфраструктура

- [x] База данных SQLite для хранения данных
- [x] Перенести хранение данных на PostgreSQL
- [x] Добавить docker-compose (bot + PostgreSQL + pgAdmin)
- [x] Логирование действий пользователей

## UX и интерфейс

- [x] Реализовать FSM-логику для интерактивных диалогов
- [x] Реализовать FSM для создания плейлиста (пошаговый диалог)
- [x] Улучшить команды: русские названия, более понятные сообщения
- [x] Добавить кнопку "Главное меню" во все диалоги
- [x] Реализовать отмену операций (например, создание плейлиста)
- [x] Улучшить UX: показ активного плейлиста, inline-кнопки для действий
- [x] Переименовать `/queen_liza` в `/delete_track`
- [x] Добавить ссылку на плейлист в Яндекс.Музыке в `/playlist_info`
- [x] Убрать ID плейлиста из отображения (не нужен пользователю)
- [x] Заменить команды на inline-кнопки для действий с плейлистом
- [x] Добавить установку обложки для плейлиста (через фото)
- [x] [Прикрепление картинки из плейлиста ЯМ в сообщение с инфо о плейлисте](tasks/task-ux-playlist-cover.md) ✅

## Обработка ошибок

- [x] Улучшить обработку ошибок (более информативные сообщения)
- [x] [Исправить удаление треков](tasks/task-bug-delete-tracks.md)
- [x] [Улучшение обработки ошибок при создании и редактировании плейлистов](tasks/task-tech-playlist-error-handling.md) ✅

## Рефакторинг кода

- [x] Рефакторинг: разделение на модули (handlers/, services/, utils/)
- [x] Вынос бизнес-логики в сервисы (YandexService, PlaylistService)
- [x] Улучшение разделения ответственности между сервисами
- [x] Устранение дублирования кода в handlers
- [x] Причесать код ответов бота на сообщения
  - Создан `utils/message_helpers.py` с функциями `send_message`, `edit_message`, `reply_to_message` и константами для общих сообщений
  - Обновлены все handlers для использования новой утилиты
- [x] Рефакторинг `button_callback` в `handlers/callbacks.py`
  - Метод разбит на отдельные методы: `handle_select_playlist`, `handle_delete_playlist`, `handle_edit_playlist`, `handle_toggle_insert_position`
  - Вынесен дублирующийся код создания клавиатуры редактирования в метод `_create_edit_playlist_keyboard`

## Технические улучшения

- [x] [Миграция на aiogram 3.x (асинхронная версия)](tasks/task-tech-aiogram-migration.md) - см. [отчет о миграции](reports/aiogram_migration_summary.md)
- [x] [Полная асинхронность БД (asyncpg/aiosqlite)](tasks/task-tech-async-db.md) ✅
- [x] [Анализ требований к серверному железу и масштабируемости](research/server_requirements.md) ✅
- [x] [Настройка CI/CD для автоматического развертывания](instructions/cicd_setup.md) ✅
- [x] [Реализация режима технических работ (Maintenance Mode)](tasks/task-tech-maintenance-mode.md) ✅

## Новые функции

- [x] Ограничение количества плейлистов на пользователя
  - Лимит: 2 плейлиста на пользователя (по умолчанию, настраивается через переменную окружения `PLAYLIST_LIMIT`)
  - При создании плейлиста проверяется текущее количество созданных плейлистов пользователя
  - При удалении плейлиста счетчик обновляется автоматически
  - Предупреждение пользователя при попытке создать плейлист сверх лимита
  - Информация о текущем использовании лимита в `/my_playlists`
- [x] Интеграция оплаты расширенных лимитов через Telegram Stars
  - Исследование возможностей Telegram Stars (см. [research/stars_payment_research.md](research/stars_payment_research.md))
  - Реализован механизм покупки расширенных лимитов через Telegram Stars
  - Хранение информации о купленных лимитах в БД (таблица `user_subscriptions` и `payments`)
  - При создании плейлиста учитываются купленные лимиты (через метод `get_user_playlist_limit`)
  - Создан PaymentService для работы с платежами
  - Добавлены обработчики платежей (pre_checkout_query, successful_payment)
  - Реализована команда `/buy_limit` для покупки подписок

## Документация

- [x] Приведение документации в соответствие с кодом
- [x] Обновить architecture.md (добавлены примеры использования сервисов)
- [x] Обновить features.md (версия обновлена до v3.0)
- [x] Обновить todo.md
- [x] Обновить commands.md
- [x] Обновить README.md (структура проекта)
- [x] Создать документацию по бекапам БД ([database_backup.md](instructions/database_backup.md))
- [x] Создать документацию по миграции БД ([database_migration.md](instructions/database_migration.md))
- [x] Создать скрипты для автоматизации бекапов и миграции (scripts/backup_db.sh, restore_db.sh, migrate_db.sh)
- [x] Добавить примеры использования (в architecture.md)

---

## Статистика

**Всего выполнено задач**: ~46+  
**Последнее обновление**: 2025

---

*Для просмотра активных задач см. [TODO](todo.md)*

