# План миграции на aiogram 3.x

## Общая информация

- **Текущее состояние**: Проект использует `python-telegram-bot==13.15` (синхронная версия)
- **Цель**: Мигрировать на `aiogram 3.x` для использования асинхронного подхода и улучшения производительности
- **Приоритет**: Высокий (улучшение производительности и современный подход)
- **Оценка времени**: 2-3 недели (зависит от сложности миграции БД и сервисов)

## Риски

- Несовместимость библиотеки `yandex-music` с асинхронным кодом (может потребоваться обертка)
- Необходимость миграции БД на асинхронные драйверы (asyncpg/aiosqlite)
- Возможные проблемы с производительностью при обертке синхронных вызовов
- Необходимость переобучения команды на новый API

## Этап 1: Подготовка и исследование

- [ ] Изучить документацию aiogram 3.x и основные отличия от python-telegram-bot
- [ ] Проанализировать совместимость библиотеки `yandex-music` с асинхронным кодом
- [ ] Проверить совместимость БД (PostgreSQL/SQLite) с асинхронными операциями
- [ ] Создать отдельную ветку для миграции (`feature/aiogram3-migration`)
- [ ] Создать резервную копию текущего рабочего кода

## Этап 2: Обновление зависимостей

- [ ] Обновить `requirements.txt`: заменить `python-telegram-bot==13.15` на `aiogram==3.x.x`
- [ ] Проверить совместимость других зависимостей (`yandex-music`, `psycopg2-binary`, `python-dotenv`)
- [ ] При необходимости добавить `aiosqlite` для асинхронной работы с SQLite
- [ ] При необходимости добавить `asyncpg` для асинхронной работы с PostgreSQL (альтернатива `psycopg2-binary`)
- [ ] Обновить Dockerfile, если потребуется изменение зависимостей

## Этап 3: Миграция базовых компонентов

- [ ] Мигрировать `bot.py`:
  - Заменить `Updater` на `Bot` и `Dispatcher`
  - Изменить `start_polling()` на `dp.start_polling()`
  - Обновить обработку сигналов для корректного завершения
  - Изменить структуру инициализации на асинхронную
- [ ] Мигрировать `handlers/keyboards.py`:
  - Заменить `ReplyKeyboardMarkup` из `telegram` на `ReplyKeyboardMarkup` из `aiogram.types`
  - Обновить импорты
- [ ] Мигрировать `utils/message_helpers.py`:
  - Заменить `Update`, `Message`, `CallbackQuery` на типы из `aiogram`
  - Изменить функции на `async def`
  - Обновить методы отправки/редактирования сообщений под aiogram API

## Этап 4: Миграция обработчиков команд

- [ ] Мигрировать `handlers/commands.py`:
  - Изменить все методы класса `CommandHandlers` на `async def`
  - Заменить `Update` и `CallbackContext` на типы из aiogram (`Message`, `CallbackQuery`, `FSMContext`)
  - Обновить методы работы с сообщениями (`reply_text`, `edit_message_text` и т.д.)
  - Заменить `ConversationHandler` на aiogram FSM (использовать `FSMContext` и состояния)
  - Мигрировать FSM состояния:
    - `WAITING_PLAYLIST_NAME` → состояние FSM
    - `WAITING_TOKEN` → состояние FSM
    - `WAITING_EDIT_NAME` → состояние FSM
    - `WAITING_TRACK_NUMBER` → состояние FSM
    - `WAITING_PLAYLIST_COVER` → состояние FSM
  - Обновить регистрацию обработчиков в `bot.py` (использовать `dp.message.register()` вместо `CommandHandler`)

## Этап 5: Миграция обработчиков callback и сообщений

- [ ] Мигрировать `handlers/callbacks.py`:
  - Изменить все методы на `async def`
  - Заменить `CallbackQuery` на тип из aiogram
  - Обновить методы работы с callback query (`answer()`, `edit_message_text()`)
  - Обновить регистрацию в `bot.py` (использовать `dp.callback_query.register()`)
- [ ] Мигрировать `handlers/messages.py`:
  - Изменить все методы на `async def`
  - Обновить обработку текстовых сообщений и ссылок
  - Обновить фильтры для обработки сообщений (использовать aiogram фильтры)
  - Обновить регистрацию в `bot.py`

## Этап 6: Миграция работы с БД и сервисами

- [ ] Проверить и обновить `database/base.py`:
  - Определить, нужны ли асинхронные методы в интерфейсе БД
  - Если да, добавить `async def` для методов, которые могут блокировать
- [ ] Мигрировать `database/postgresql_db.py`:
  - Использовать `asyncpg` вместо `psycopg2-binary` для асинхронной работы
  - Или обернуть синхронные вызовы в `asyncio.to_thread()` для совместимости
  - Обновить все методы на `async def` при необходимости
- [ ] Мигрировать `database/sqlite_db.py`:
  - Использовать `aiosqlite` для асинхронной работы с SQLite
  - Обновить все методы на `async def`
- [ ] Обновить `yandex_client_manager.py`:
  - Проверить, поддерживает ли `yandex-music` асинхронные операции
  - Если нет, обернуть синхронные вызовы в `asyncio.to_thread()`
  - Обновить методы на `async def` при необходимости
- [ ] Обновить сервисы (`services/yandex_service.py`, `services/playlist_service.py`, `services/payment_service.py`, `services/link_parser.py`):
  - Изменить методы на `async def`
  - Обновить вызовы БД и клиентов на асинхронные
- [ ] Обновить `utils/context.py`:
  - Изменить методы на `async def`
  - Обновить работу с БД на асинхронную

## Этап 7: Обновление FSM (Finite State Machine)

- [ ] Создать файл `handlers/states.py` с определениями состояний FSM через aiogram:
  - `CreatePlaylistStates` (WAITING_PLAYLIST_NAME)
  - `SetTokenStates` (WAITING_TOKEN)
  - `EditNameStates` (WAITING_EDIT_NAME)
  - `DeleteTrackStates` (WAITING_TRACK_NUMBER)
  - `SetCoverStates` (WAITING_PLAYLIST_COVER)
- [ ] Обновить обработчики для использования FSM состояний вместо числовых констант
- [ ] Заменить `ConversationHandler` на aiogram FSM роутеры
- [ ] Обновить логику переходов между состояниями

## Этап 8: Обновление обработки ошибок и middleware

- [ ] Обновить `error_handler` в `bot.py` для работы с aiogram
- [ ] При необходимости добавить middleware для обработки ошибок
- [ ] Обновить логирование ошибок под новую структуру

## Этап 9: Тестирование

- [ ] Протестировать все команды бота (`/start`, `/create_playlist`, `/my_playlists` и т.д.)
- [ ] Протестировать FSM диалоги (создание плейлиста, установка токена, редактирование названия, удаление трека, установка обложки)
- [ ] Протестировать callback query (выбор плейлиста, удаление, редактирование, покупка лимитов)
- [ ] Протестировать обработку текстовых сообщений (добавление треков, альбомов, плейлистов)
- [ ] Протестировать обработку платежей (Telegram Stars)
- [ ] Проверить работу с БД (создание пользователей, плейлистов, треков)
- [ ] Проверить работу с API Яндекс.Музыки
- [ ] Проверить обработку ошибок и edge cases
- [ ] Провести нагрузочное тестирование (множественные одновременные запросы)

## Этап 10: Документация и финализация

- [ ] Обновить `docs/architecture.md` с описанием новой архитектуры на aiogram 3.x
- [ ] Обновить `README.md` с информацией о миграции и новых зависимостях
- [ ] Обновить `docs/commands.md` при необходимости
- [ ] Создать `docs/migration_guide.md` с описанием процесса миграции и основных изменений
- [ ] Обновить комментарии в коде при необходимости
- [ ] Проверить и обновить CI/CD pipeline при необходимости

## Этап 11: Развертывание

- [ ] Создать pull request с миграцией
- [ ] Провести code review
- [ ] Протестировать на staging окружении
- [ ] Развернуть на production после успешного тестирования
- [ ] Мониторить работу бота после развертывания

